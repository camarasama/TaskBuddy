// TaskBuddy Database Schema
// Based on APP_DEVELOPMENT_INSTRUCTIONS.md v2.0

generator client {
  provider = "prisma-client-js"
  url = env("DATABASE_URL")
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
}

// ============================================
// CORE TABLES
// ============================================

model Family {
  id         String    @id @default(uuid())
  familyName String    @map("family_name")
  familyCode String?   @unique @map("family_code")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")
  // M8 — Admin: allows admin to suspend a family (blocks all logins for that family)
  isSuspended  Boolean   @default(false) @map("is_suspended")
  suspendedAt  DateTime? @map("suspended_at")
  suspendedBy  String?   @map("suspended_by")

  // Relations
  users           User[]
  taskTemplates   TaskTemplate[]
  tasks           Task[]
  rewards         Reward[]
  dailyChallenges DailyChallenge[]
  settings        FamilySettings?
  invitations     FamilyInvitation[]
  emailLogs       EmailLog[]

  @@map("families")
}

model User {
  id           String    @id @default(uuid())
  familyId     String?    @map("family_id")
  email        String?   @unique
  username     String?
  passwordHash String?   @map("password_hash")
  role         UserRole
  firstName    String    @map("first_name")
  lastName     String    @map("last_name")
  avatarUrl    String?   @map("avatar_url")
  isPrimaryParent Boolean   @default(false) @map("is_primary_parent")
  dateOfBirth     DateTime? @map("date_of_birth") @db.Date
  phone           String?
  isActive        Boolean   @default(true) @map("is_active")
  lockedUntil     DateTime? @map("locked_until")
  lastLoginAt     DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  family                Family?             @relation(fields: [familyId], references: [id], onDelete: Cascade)
  childProfile          ChildProfile?
  createdTasks          Task[]              @relation("CreatedTasks")
  taskAssignments       TaskAssignment[]    @relation("AssignedTasks")
  approvedAssignments   TaskAssignment[]    @relation("ApprovedAssignments")
  createdRewards        Reward[]
  rewardRedemptions     RewardRedemption[]
  childAchievements     ChildAchievement[]
  challengeCompletions  ChallengeCompletion[]
  notifications         Notification[]
  pointsLedger          PointsLedger[]      @relation("ChildPoints")
  createdPointsEntries  PointsLedger[]      @relation("CreatedPointsEntries")
  createdTemplates      TaskTemplate[]
  sentInvitations       FamilyInvitation[]  @relation("SentInvitations")
  emailLogs             EmailLog[]          @relation("ReceivedEmails")

  @@index([familyId])
  @@index([email])
  @@index([role])
  @@index([username])
  @@map("users")
}

model ChildProfile {
  id                  String    @id @default(uuid())
  userId              String    @unique @map("user_id")
  dateOfBirth         DateTime  @map("date_of_birth") @db.Date
  ageGroup            AgeGroup? @map("age_group")
  pinHash             String?   @map("pin_hash")
  pointsBalance       Int       @default(0) @map("points_balance")
  totalPointsEarned   Int       @default(0) @map("total_points_earned")
  totalTasksCompleted Int       @default(0) @map("total_tasks_completed")
  currentStreakDays   Int       @default(0) @map("current_streak_days")
  longestStreakDays   Int       @default(0) @map("longest_streak_days")
  lastStreakDate      DateTime? @map("last_streak_date") @db.Date
  lastActivityDate    DateTime? @map("last_activity_date")
  level               Int       @default(1)
  experiencePoints    Int       @default(0) @map("experience_points")
  // M7 — CR-06: lifetime XP earned (never decremented — separate from spendable Points)
  totalXpEarned       Int       @default(0) @map("total_xp_earned")
  // M10 — Phase 5: selected emoji avatar from the avatar picker grid
  avatarEmoji         String?   @map("avatar_emoji")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("child_profiles")
}

// ============================================
// TASK MANAGEMENT
// ============================================

model TaskTemplate {
  id                    String          @id @default(uuid())
  familyId              String          @map("family_id")
  name                  String
  description           String?
  category              String?
  difficulty            TaskDifficulty?
  suggestedPoints       Int             @default(10) @map("suggested_points")
  estimatedMinutes      Int?            @map("estimated_minutes")
  ageRange              String?         @map("age_range")
  requiresPhotoEvidence Boolean         @default(false) @map("requires_photo_evidence")
  isSystemTemplate      Boolean         @default(false) @map("is_system_template")
  createdBy             String?         @map("created_by")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")

  // Relations
  family  Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator User?  @relation(fields: [createdBy], references: [id])
  tasks   Task[]

  @@index([familyId])
  @@index([category])
  @@map("task_templates")
}

model Task {
  id                    String          @id @default(uuid())
  familyId              String          @map("family_id")
  templateId            String?         @map("template_id")
  createdBy             String          @map("created_by")
  title                 String
  description           String?
  category              String?
  difficulty            TaskDifficulty?
  // M5 — CR-01: primary = must-do, secondary = bonus/self-assignable
  taskTag               TaskTag         @default(primary) @map("task_tag")
  pointsValue           Int             @default(10) @map("points_value")
  dueDate               DateTime?       @map("due_date")
  // M5 — CR-09: optional scheduling fields for overlap detection
  startTime             DateTime?       @map("start_time")
  estimatedMinutes      Int?            @map("estimated_minutes")
  requiresPhotoEvidence Boolean         @default(false) @map("requires_photo_evidence")
  isRecurring           Boolean         @default(false) @map("is_recurring")
  recurrencePattern     String?         @map("recurrence_pattern")
  recurrenceConfig      Json?           @map("recurrence_config")
  autoApprove           Boolean         @default(false) @map("auto_approve")
  status                TaskStatus      @default(active)
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  deletedAt             DateTime?       @map("deleted_at")

  // Relations
  family      Family           @relation(fields: [familyId], references: [id], onDelete: Cascade)
  template    TaskTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  creator     User             @relation("CreatedTasks", fields: [createdBy], references: [id])
  assignments TaskAssignment[]

  @@index([familyId])
  @@index([dueDate])
  @@index([status])
  @@index([category])
  @@map("tasks")
}

model TaskAssignment {
  id              String           @id @default(uuid())
  taskId          String           @map("task_id")
  childId         String           @map("child_id")
  instanceDate    DateTime         @map("instance_date") @db.Date
  status          AssignmentStatus @default(pending)
  completedAt     DateTime?        @map("completed_at")
  approvedAt      DateTime?        @map("approved_at")
  approvedBy      String?          @map("approved_by")
  rejectionReason String?          @map("rejection_reason")
  pointsAwarded   Int?             @map("points_awarded")
  xpAwarded       Int?             @map("xp_awarded")
  // M9 — tracks when the expiry-warning email was sent to prevent duplicate cron emails
  emailSentAt     DateTime?        @map("email_sent_at")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  // Relations
  task     Task           @relation(fields: [taskId], references: [id], onDelete: Cascade)
  child    User           @relation("AssignedTasks", fields: [childId], references: [id], onDelete: Cascade)
  approver User?          @relation("ApprovedAssignments", fields: [approvedBy], references: [id])
  evidence TaskEvidence[]

  @@unique([taskId, childId, instanceDate])
  @@index([taskId])
  @@index([childId])
  @@index([status])
  @@index([instanceDate])
  // M9 — index for the expiry cron so it can efficiently find un-emailed assignments
  @@index([emailSentAt])
  @@map("task_assignments")
}

model TaskEvidence {
  id               String           @id @default(uuid())
  assignmentId     String           @map("assignment_id")
  evidenceType     EvidenceType
  fileUrl          String?          @map("file_url")
  fileKey          String?          @map("file_key")
  fileSizeBytes    Int?             @map("file_size_bytes")
  mimeType         String?          @map("mime_type")
  thumbnailUrl     String?          @map("thumbnail_url")
  note             String?
  moderationStatus ModerationStatus @default(pending) @map("moderation_status")
  uploadedAt       DateTime         @default(now()) @map("uploaded_at")

  // Relations
  assignment TaskAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@map("task_evidence")
}

// ============================================
// POINTS & REWARDS
// ============================================

model PointsLedger {
  id              String          @id @default(uuid())
  childId         String          @map("child_id")
  transactionType TransactionType @map("transaction_type")
  pointsAmount    Int             @map("points_amount")
  balanceAfter    Int             @map("balance_after")
  referenceType   String?         @map("reference_type")
  referenceId     String?         @map("reference_id")
  description     String?
  breakdown       Json?
  createdBy       String?         @map("created_by")
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relations
  child   User  @relation("ChildPoints", fields: [childId], references: [id], onDelete: Cascade)
  creator User? @relation("CreatedPointsEntries", fields: [createdBy], references: [id])

  @@index([childId])
  @@index([createdAt])
  @@index([transactionType])
  @@map("points_ledger")
}

model Reward {
  id                     String      @id @default(uuid())
  familyId               String      @map("family_id")
  createdBy              String      @map("created_by")
  name                   String
  description            String?
  pointsCost             Int         @map("points_cost")
  tier                   RewardTier?
  iconUrl                String?     @map("icon_url")
  isActive               Boolean     @default(true) @map("is_active")
  maxRedemptionsPerChild Int?        @map("max_redemptions_per_child")
  // M6 — CR-11: household-level redemption cap (total across all children)
  maxRedemptionsTotal    Int?        @map("max_redemptions_total")
  expiresAt              DateTime?   @map("expires_at")
  isCollaborative        Boolean     @default(false) @map("is_collaborative")
  createdAt              DateTime    @default(now()) @map("created_at")
  updatedAt              DateTime    @updatedAt @map("updated_at")
  deletedAt              DateTime?   @map("deleted_at")

  // Relations
  family      Family             @relation(fields: [familyId], references: [id], onDelete: Cascade)
  creator     User               @relation(fields: [createdBy], references: [id])
  redemptions RewardRedemption[]

  @@index([familyId])
  @@index([isActive])
  @@index([tier])
  @@map("rewards")
}

model RewardRedemption {
  id          String           @id @default(uuid())
  rewardId    String           @map("reward_id")
  childId     String           @map("child_id")
  pointsSpent Int              @map("points_spent")
  status      RedemptionStatus @default(pending)
  approvedBy  String?          @map("approved_by")
  approvedAt  DateTime?        @map("approved_at")
  fulfilledAt DateTime?        @map("fulfilled_at")
  notes       String?
  createdAt   DateTime         @default(now()) @map("created_at")

  // Relations
  reward Reward @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  child  User   @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([rewardId])
  @@index([childId])
  @@index([status])
  @@map("reward_redemptions")
}

// ============================================
// GAMIFICATION
// ============================================

model Achievement {
  id                    String           @id @default(uuid())
  name                  String
  description           String?
  iconUrl               String?          @map("icon_url")
  category              String?
  unlockCriteriaType    String?          @map("unlock_criteria_type")
  unlockCriteriaValue   Int?             @map("unlock_criteria_value")
  unlockCriteriaConfig  Json?            @map("unlock_criteria_config")
  tier                  AchievementTier?
  isSystemAchievement   Boolean          @default(true) @map("is_system_achievement")
  pointsReward          Int              @default(0) @map("points_reward")
  xpReward              Int              @default(0) @map("xp_reward")
  // M10 — Phase 4: minimum XP level required to unlock (used in R-05 level distribution)
  xpThreshold           Int              @default(0) @map("xp_threshold")
  createdAt             DateTime         @default(now()) @map("created_at")

  // Relations
  childAchievements ChildAchievement[]

  @@index([category])
  @@index([tier])
  @@map("achievements")
}

model ChildAchievement {
  id            String   @id @default(uuid())
  childId       String   @map("child_id")
  achievementId String   @map("achievement_id")
  unlockedAt    DateTime @default(now()) @map("unlocked_at")
  progressValue Int?     @map("progress_value")

  // Relations
  child       User        @relation(fields: [childId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([childId, achievementId])
  @@index([childId])
  @@index([unlockedAt])
  @@map("child_achievements")
}

model DailyChallenge {
  id            String   @id @default(uuid())
  familyId      String   @map("family_id")
  challengeDate DateTime @map("challenge_date") @db.Date
  title         String
  description   String?
  challengeType String?  @map("challenge_type")
  criteria      Json?
  bonusPoints   Int      @map("bonus_points")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  family      Family                @relation(fields: [familyId], references: [id], onDelete: Cascade)
  completions ChallengeCompletion[]

  @@unique([familyId, challengeDate])
  @@index([familyId])
  @@index([challengeDate])
  @@map("daily_challenges")
}

model ChallengeCompletion {
  id                 String   @id @default(uuid())
  challengeId        String   @map("challenge_id")
  childId            String   @map("child_id")
  completedAt        DateTime @default(now()) @map("completed_at")
  bonusPointsAwarded Int?     @map("bonus_points_awarded")

  // Relations
  challenge DailyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  child     User           @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@unique([challengeId, childId])
  @@index([challengeId])
  @@index([childId])
  @@map("challenge_completions")
}

// ============================================
// NOTIFICATIONS & SETTINGS
// ============================================

model Notification {
  id               String    @id @default(uuid())
  userId           String    @map("user_id")
  notificationType String    @map("notification_type")
  title            String
  message          String
  actionUrl        String?   @map("action_url")
  referenceType    String?   @map("reference_type")
  referenceId      String?   @map("reference_id")
  isRead           Boolean   @default(false) @map("is_read")
  readAt           DateTime? @map("read_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Composite index: covers WHERE userId=X (AND isRead=Y) ORDER BY createdAt DESC
  // Replaces 3 separate single-column indexes which forced the DB to pick just one.
  @@index([userId, isRead, createdAt(sort: Desc)])
  @@map("notifications")
}

model FamilySettings {
  id                        String   @id @default(uuid())
  familyId                  String   @unique @map("family_id")
  autoApproveRecurringTasks Boolean  @default(false) @map("auto_approve_recurring_tasks")
  enableDailyChallenges     Boolean  @default(true) @map("enable_daily_challenges")
  enableLeaderboard         Boolean  @default(false) @map("enable_leaderboard")
  streakGracePeriodHours    Int      @default(4) @map("streak_grace_period_hours")
  // M9 — CR-08: per-family email notification preferences.
  // Keys: task_submitted | task_approved | task_rejected | task_expiring | task_expired |
  //       reward_redeemed | level_up | streak_at_risk | welcome | co_parent_invite
  // Default: all enabled. Individual parents can override per-key via PUT /families/me/settings.
  notificationPreferences   Json     @default("{\"task_submitted\":true,\"task_approved\":true,\"task_rejected\":true,\"task_expiring\":true,\"task_expired\":true,\"reward_redeemed\":true,\"level_up\":true,\"streak_at_risk\":true,\"welcome\":true,\"co_parent_invite\":true}") @map("notification_preferences")
  theme                     String   @default("default")
  language                  String   @default("en")
  timezone                  String   @default("UTC")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  // Relations
  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@map("family_settings")
}

// ============================================
// CO-PARENT INVITATIONS (M4)
// ============================================

model FamilyInvitation {
  id              String    @id @default(uuid())
  familyId        String    @map("family_id")
  invitedByUserId String    @map("invited_by_user_id")
  email           String
  token           String    @unique
  expiresAt       DateTime  @map("expires_at")
  acceptedAt      DateTime? @map("accepted_at")
  // M10 — Phase 4: R-08 tracks co-parent invite acceptance rate
  cancelledAt     DateTime? @map("cancelled_at")
  relationship    String?   // e.g. "spouse", "partner", "guardian"
  createdAt       DateTime  @default(now()) @map("created_at")

  // Relations
  family      Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  invitedBy   User   @relation("SentInvitations", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@index([familyId])
  @@index([token])
  @@index([email])
  @@map("family_invitations")
}

// ============================================
// M8 — ADMIN & AUDIT
// ============================================

/**
 * AuditLog — immutable record of every mutating action in the system.
 * Written by AuditService.logAction() from all mutating routes.
 * Never updated or deleted — admin can only read and export.
 *
 * action examples    : CREATE | UPDATE | DELETE | APPROVE | REJECT |
 *                      REDEEM | FULFILL | SUSPEND | REACTIVATE | LOGIN |
 *                      REGISTER | INVITE_SENT | INVITE_ACCEPTED | FORCE_RESET
 * resourceType examples: task | task_assignment | reward | reward_redemption |
 *                        family | user | child | invitation | achievement
 * metadata           : arbitrary JSON snapshot — e.g. { before, after } for
 *                      updates, or { reason } for suspensions.
 */
model AuditLog {
  id           String   @id @default(uuid())
  // The user who performed the action (null for system/cron actions)
  actorId      String?  @map("actor_id")
  // Human-readable action verb (see examples above)
  action       String
  // The type of resource affected
  resourceType String   @map("resource_type")
  // The ID of the affected resource
  resourceId   String   @map("resource_id")
  // Optional family scope — null for cross-family admin actions
  familyId     String?  @map("family_id")
  // Optional JSON payload: before/after state, extra context
  metadata     Json?
  // IP address of the actor (for security audit purposes)
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([actorId])
  @@index([resourceType])
  @@index([resourceId])
  @@index([familyId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// M9 — EMAIL LOGS
// ============================================

/**
 * EmailLog — immutable record of every email attempt made by EmailService.
 *
 * EmailService writes a row here for every send attempt whether it succeeds
 * or fails. The admin email log viewer reads this table.
 *
 * triggerType mirrors the notificationPreferences keys so the opt-out check
 * can reference the same string:
 *   task_submitted | task_approved | task_rejected | task_expiring |
 *   task_expired   | reward_redeemed | level_up | streak_at_risk |
 *   welcome        | co_parent_invite
 *
 * status:
 *   sent    — SMTP accepted the message (no bounce detected yet)
 *   failed  — SMTP threw an error; errorMessage has details
 *   bounced — future use via webhook (not implemented in M9)
 */
model EmailLog {
  id           String          @id @default(uuid())
  // Recipient email address (denormalised — user may be deleted later)
  toEmail      String          @map("to_email")
  // The user this email was sent to (null if family-level send or user deleted)
  toUserId     String?         @map("to_user_id")
  toUser       User?           @relation("ReceivedEmails", fields: [toUserId], references: [id], onDelete: SetNull)
  family       Family?         @relation(fields: [familyId], references: [id], onDelete: SetNull)
  // Family scope — null for admin-triggered emails
  familyId     String?         @map("family_id")
  // Which template / notification type triggered this email
  triggerType  String          @map("trigger_type")
  // Email subject line (stored for the admin resend UI)
  subject      String
  // Delivery outcome
  status       EmailLogStatus  @default(sent)
  // Populated when status = failed
  errorMessage String?         @map("error_message")
  // The resource that triggered this email (e.g. assignment id, redemption id)
  referenceType String?        @map("reference_type")
  referenceId   String?        @map("reference_id")
  // M9 — admin resend: tracks how many times this specific log entry was re-sent
  resendCount  Int             @default(0) @map("resend_count")
  lastResentAt DateTime?       @map("last_resent_at")
  createdAt    DateTime        @default(now()) @map("created_at")

  @@index([toUserId])
  @@index([familyId])
  @@index([triggerType])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  parent
  child
  admin
}

enum AgeGroup {
  YOUNGER @map("10-12")
  OLDER   @map("13-16")
}

enum TaskDifficulty {
  easy
  medium
  hard
}

// M5 — CR-01: task classification
enum TaskTag {
  primary   // Must-do task assigned by parent
  secondary // Bonus/optional task; child can self-assign if no primary is pending
}

enum TaskStatus {
  active
  paused
  archived
}

enum AssignmentStatus {
  pending
  in_progress
  completed
  approved
  rejected
}

enum TransactionType {
  earned
  redeemed
  bonus
  penalty
  adjustment
  // M7 — CR-06: awarded when child levels up or hits a streak milestone
  milestone_bonus
}

enum RewardTier {
  small
  medium
  large
}

enum AchievementTier {
  bronze
  silver
  gold
  platinum
}

enum RedemptionStatus {
  pending
  approved
  fulfilled
  cancelled
}

enum EvidenceType {
  photo
  note
  video
}

enum ModerationStatus {
  pending
  approved
  flagged
  rejected
}

// M9 — email delivery status
enum EmailLogStatus {
  sent
  failed
  bounced
}